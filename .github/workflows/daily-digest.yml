name: Daily Digest

on:
  schedule:
    - cron: "0 13 * * *" # daily at 13:00 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-digest-${{ github.ref }}
  cancel-in-progress: true

jobs:
  digest:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run digest bot
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNELS: ${{ secrets.DISCORD_CHANNELS }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
          MAX_SUMMARY_TOKENS: ${{ vars.MAX_SUMMARY_TOKENS }}
          DRY_RUN: ${{ vars.DRY_RUN }}
          DIGEST_WINDOW_HOURS: ${{ vars.DIGEST_WINDOW_HOURS }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          MIN_MESSAGE_LENGTH: ${{ vars.MIN_MESSAGE_LENGTH }}
          EXCLUDE_COMMANDS: ${{ vars.EXCLUDE_COMMANDS }}
          EXCLUDE_LINK_ONLY: ${{ vars.EXCLUDE_LINK_ONLY }}
        run: npm start
