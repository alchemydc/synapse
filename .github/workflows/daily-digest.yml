name: Daily Digest

on:
  schedule:
    - cron: "0 13 * * *" # daily at 13:00 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-digest-${{ github.ref }}
  cancel-in-progress: true

jobs:
  digest:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Run digest bot
        env:
          DRY_RUN: ${{ vars.DRY_RUN }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          ENABLE_DISCORD: ${{ vars.ENABLE_DISCORD }}
          ENABLE_DISCOURSE: ${{ vars.ENABLE_DISCOURSE }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNELS: ${{ secrets.DISCORD_CHANNELS }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCOURSE_API_KEY: ${{ secrets.DISCOURSE_API_KEY }}
          DISCOURSE_API_USERNAME: ${{ secrets.DISCOURSE_API_USERNAME }}
          DISCOURSE_BASE_URL: ${{ vars.DISCOURSE_BASE_URL }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
          MAX_SUMMARY_TOKENS: ${{ vars.MAX_SUMMARY_TOKENS }}
          DIGEST_WINDOW_HOURS: ${{ vars.DIGEST_WINDOW_HOURS }}
          MIN_MESSAGE_LENGTH: ${{ vars.MIN_MESSAGE_LENGTH }}
          EXCLUDE_COMMANDS: ${{ vars.EXCLUDE_COMMANDS }}
          EXCLUDE_LINK_ONLY: ${{ vars.EXCLUDE_LINK_ONLY }}
          ATTRIBUTION_ENABLED: ${{ vars.ATTRIBUTION_ENABLED }}
          TOPIC_GAP_MINUTES: ${{ vars.TOPIC_GAP_MINUTES }}
          MAX_TOPIC_PARTICIPANTS: ${{ vars.MAX_TOPIC_PARTICIPANTS }}
          ATTRIBUTION_FALLBACK_ENABLED: ${{ vars.ATTRIBUTION_FALLBACK_ENABLED }}
        run: npm start
